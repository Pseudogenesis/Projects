local impendTable = {}

local pos

-- Wheel states: 1=Ire, 2=Joy, 3=Calm, 4=Sorrow

local EMOTIONS = {"Ire", "Joy", "Calm", "Sorrow"}

local seasonWheel = nil

local activated = false

local playerColor = nil

local busy = false  -- Prevents rapid clicking



-----------------------------------------

-- Forward declarations for local functions

-----------------------------------------

local getWheelEmotion

local setWheelToEmotion

local findInnateWithTagInHand

local findInnateWithTagInHandObjects

local getEmotionIndex

local getNextEmotionIndex

local cycleSeasonWheel



-----------------------------------------

-- Local function implementations

-----------------------------------------



getWheelEmotion = function()

    if not seasonWheel then return "Ire" end

    local stateId = seasonWheel.getStateId()

    if stateId == -1 then stateId = 1 end

    -- States: 1=Ire, 2=Joy, 3=Calm, 4=Sorrow

    return EMOTIONS[stateId] or "Ire"

end



setWheelToEmotion = function(emotionTag)

    if not seasonWheel then return end



    -- Find which state index matches this emotion

    local targetState = 1

    for i, emotion in ipairs(EMOTIONS) do

        if emotion == emotionTag then

            targetState = i

            break

        end

    end



    local currentState = seasonWheel.getStateId()

    if currentState == -1 then currentState = 1 end



    -- Only change if different

    if targetState ~= currentState then

        seasonWheel = seasonWheel.setState(targetState)

    end

end



findInnateWithTagInHand = function(color, handIndex, tagName)

    local hand = Player[color].getHandObjects(handIndex)

    for _, obj in ipairs(hand) do

        if obj.hasTag("Innate") and obj.hasTag(tagName) then

            return obj

        end

    end

    return nil

end



-- Version that searches a provided hand objects table

findInnateWithTagInHandObjects = function(handObjects, tagName)

    for _, obj in ipairs(handObjects) do

        if obj.hasTag("Innate") and obj.hasTag(tagName) then

            return obj

        end

    end

    return nil

end



getEmotionIndex = function(card)

    for i, tag in ipairs(EMOTIONS) do

        if card.hasTag(tag) then return i end

    end

    return 1 -- default to Ire if none

end



-- Get the next emotion index (not tag) given a card

getNextEmotionIndex = function(card, reverse)

    local i = getEmotionIndex(card)

    if reverse then

        -- Go backwards: 1->4, 2->1, 3->2, 4->3

        return ((i - 2) % #EMOTIONS) + 1

    else

        -- Go forwards: 1->2, 2->3, 3->4, 4->1

        return (i % #EMOTIONS) + 1

    end

end



cycleSeasonWheel = function(reverse)

    if not seasonWheel then return end



    local currentState = seasonWheel.getStateId()

    if currentState == -1 then return end -- No states



    -- getStates() returns all states EXCEPT the current one, so total = #getStates + 1

    local states = seasonWheel.getStates()

    if not states then return end

    local numStates = #states + 1



    local nextState

    if reverse then

        -- Go backwards: 1->4, 2->1, 3->2, 4->3

        nextState = ((currentState - 2) % numStates) + 1

    else

        -- Go forwards: 1->2, 2->3, 3->4, 4->1

        nextState = (currentState % numStates) + 1

    end



    -- setState returns new object reference; update our reference

    if nextState ~= currentState then

        seasonWheel = seasonWheel.setState(nextState)

    end

end



-----------------------------------------

-- Setup function

-----------------------------------------



function doSetup(params)

    local color = params.color

    playerColor = color

    local panel = params.spiritPanel

    self.locked = true

    local position = panel.getPosition() + Vector(-8.2,-0.22,6.8)

    pos = position

    self.setPosition(position)



    -- Find the Season Wheel object by searching for it on the table

    for _, obj in ipairs(getAllObjects()) do

        if obj.getName():find("Season Wheel") then

            seasonWheel = obj

            break

        end

    end



    -- Spawn the new hand (hand index 3)

    local handPosition = Player[color].getHandTransform(2).position

    handPosition.z = handPosition.z - 5.5

    Global.call("SpawnHand", {color = color, position = handPosition})



    -- Determine which emotion the wheel is currently showing

    local startingEmotion = getWheelEmotion()



    -- Get current hand and process Innate cards

    local hand = Player[color].getHandObjects(1)

    Wait.frames(function()

        if hand ~= {} then

            -- Find the card that matches the wheel's starting emotion

            local startingCard = findInnateWithTagInHandObjects(hand, startingEmotion)



            for _,card in pairs(hand) do

                if card.hasTag("Innate") then

                    if card == startingCard then

                        -- Place matching card directly on the panel

                        local targetPos = pos + Vector(13, 0.5, -10)

                        card.setPosition(targetPos, false)

                    else

                        -- Send other innates to hand 3

                        card.deal(1, color, 3)

                    end

                end

            end

        end

    end, 1)



    createPanelButtons(panel)



    return true

end



-----------------------------------------

-- Panel button creation

-----------------------------------------



function createPanelButtons(panel)

    panel.createButton({

        click_function = "changeSeason",

        function_owner = self,

        label = "Change Season",

        position = {-0.93,0.5,0},

        scale = {x=0.08, y=0.08, z=0.08},

        width = 5000,

        height = 750,

        font_size = 750,

        color = {1,1,1},

        font_color = {0,0,0},

        tooltip = "Left-click: Next Season | Right-click: Previous Season",

    })

end



-----------------------------------------

-- Change Season (button click handler)

-----------------------------------------



function changeSeason(obj, player_color, alt_click)

    -- Prevent rapid clicking while cards are moving

    if busy then return end

    busy = true





    local color = Global.call("getSpiritColor", {name = spiritName})

    local reverse = alt_click -- true for right-click (go backwards)



    local hits = Physics.cast({

        origin = obj.getPosition() + Vector(5,0,-5),

        direction = Vector(0,1,0),

        type = 3,

        size = {6,1,6.5},

        max_distance = 1,

        -- debug = true

    })



    -- First, find the innate card in the hits

    local innateCard = nil

    for _, hit in pairs(hits) do

        local card = hit.hit_object

        if card and card.hasTag("Innate") then

            innateCard = card

            break

        end

    end

            -- Calculate the NEXT emotion index based on current card

            local nextIndex = getNextEmotionIndex(card, reverse)

            local wantTag = EMOTIONS[nextIndex]



    if innateCard then

        local targetPos = innateCard.getPosition()

        local targetRot = innateCard.getRotation()

            -- Pull the next emotion card from hand 3 back to the panel

            local replacement = findInnateWithTagInHand(color, 3, wantTag)

            if replacement then

                replacement.setPosition(targetPos, false)

                replacement.setRotation(targetRot, false)

            end



        -- Calculate the NEXT emotion index based on current card

        local nextIndex = getNextEmotionIndex(innateCard, reverse)

        local wantTag = EMOTIONS[nextIndex]



        -- Move the current card to hand 3

        innateCard.deal(1, color, 3)



        -- Pull the next emotion card from hand 3 back to the panel

        local replacement = findInnateWithTagInHand(color, 3, wantTag)

        if replacement then

            replacement.setPosition(targetPos, false)

            replacement.setRotation(targetRot, false)

        end



        -- Set the wheel directly to the NEW emotion state

        setWheelToEmotion(wantTag)

    else

        -- No innate on panel, place the default (Ire)

        local replacement = findInnateWithTagInHand(color, 3, "Ire")

        if replacement then

            replacement.setPosition(pos + Vector(13,0.5,-10), false)

        end

    end
	

    -- Release busy flag after cards have time to move

    Wait.frames(function()

        busy = false

    end, 20)

end
-- Time Passes handler

-----------------------------------------



function timePasses()

    local color = Global.call("getSpiritColor", {name = spiritName})

    local hits = Physics.cast({

        origin = self.getPosition() + Vector(5,0,-5),

        direction = Vector(0,1,0),

        type = 3,

        size = {6,1,6.5},

        max_distance = 1,

        -- debug = true

    })



    -- First, find the innate card in the hits

    local innateCard = nil

    for _, hit in pairs(hits) do

        local card = hit.hit_object

        if card and card.hasTag("Innate") then

            innateCard = card

            break

        end

    end



    if innateCard then

        local targetPos = innateCard.getPosition()

        local targetRot = innateCard.getRotation()



        -- Calculate the NEXT emotion index (always forward for timePasses)

        local nextIndex = getNextEmotionIndex(innateCard, false)

        local wantTag = EMOTIONS[nextIndex]



        -- Move the current card to hand 3

        innateCard.deal(1, color, 3)



        -- Pull the next emotion card from hand 3 back to the panel

        local replacement = findInnateWithTagInHand(color, 3, wantTag)

        if replacement then

            replacement.setPosition(targetPos, false)

            replacement.setRotation(targetRot, false)

        end



        -- Set the wheel directly to the NEW emotion state

        setWheelToEmotion(wantTag)

    else

        -- No innate on panel, place the default (Ire)

        local replacement = findInnateWithTagInHand(color, 3, "Ire")

        if replacement then
            replacement.setPosition(pos + Vector(13,0.5,-10), false)

        end

    end

end



-----------------------------------------

-- Cost modification (called by mod framework)

-----------------------------------------



function modifyCost(params)

    local costs = params.costs

    if params.color == Global.call("getSpiritColor", {name = spiritName}) then

        for guid,_ in pairs(costs) do

            if impendTable[guid] then

                costs[guid] = 0

            end

        end

    end

    return costs

end

"
