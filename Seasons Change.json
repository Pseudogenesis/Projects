{
  "SaveName": "",
  "Date": "",
  "VersionNumber": "",
  "GameMode": "",
  "GameType": "",
  "GameComplexity": "",
  "Tags": [],
  "Gravity": 0.5,
  "PlayArea": 0.5,
  "Table": "",
  "Sky": "",
  "Note": "",
  "TabStates": {},
  "LuaScript": "",
  "LuaScriptState": "",
  "XmlUI": "",
  "ObjectStates": [
    {
      "GUID": "DUESETUP",
      "Name": "Custom_Model",
      "Transform": {
        "posX": -17.6946373,
        "posY": 0.868099034,
        "posZ": -28.39949,
        "rotX": -1.53153028E-08,
        "rotY": 179.987747,
        "rotZ": -6.052557E-09,
        "scaleX": 1.0,
        "scaleY": 0.1,
        "scaleZ": 1.0
      },
      "Nickname": "Seasons Change",
      "Description": "",
      "GMNotes": "",
      "AltLookAngle": {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0
      },
      "ColorDiffuse": {
        "r": 0.0287,
        "g": 0.378699422,
        "b": 0.716
      },
      "Tags": [
        "Gain Pay",
        "Modify Cost",
        "Setup",
        "Time Passes"
      ],
      "LayoutGroupSortIndex": 0,
      "Value": 0,
      "Locked": false,
      "Grid": false,
      "Snap": false,
      "IgnoreFoW": false,
      "MeasureMovement": false,
      "DragSelectable": true,
      "Autoraise": true,
      "Sticky": true,
      "Tooltip": true,
      "GridProjection": false,
      "HideWhenFaceDown": false,
      "Hands": false,
      "CustomMesh": {
        "MeshURL": "https://steamusercontent-a.akamaihd.net/ugc/1673610911187396692/B6ECCABF6AD6DDDC3F81C555D2036BED1F2F48FD/",
        "DiffuseURL": "",
        "NormalURL": "",
        "ColliderURL": "",
        "Convex": true,
        "MaterialIndex": 3,
        "TypeIndex": 0,
        "CustomShader": {
          "SpecularColor": {
            "r": 1.0,
            "g": 1.0,
            "b": 1.0
          },
          "SpecularIntensity": 0.0,
          "SpecularSharpness": 2.0,
          "FresnelStrength": 0.0
        },
        "CastShadows": true
      },
      "LuaScript": "spiritName = \"Tempers of the Ever-Changing Skies\"\r\n\r\nlocal impendTable = {}\r\nlocal pos\r\n-- Wheel states: 1=Ire, 2=Joy, 3=Calm, 4=Sorrow\r\nlocal EMOTIONS = {\"Ire\", \"Joy\", \"Calm\", \"Sorrow\"}\r\nlocal seasonWheel = nil\r\nlocal activated = false\r\nlocal playerColor = nil\r\nlocal panelGUID = nil  -- Store panel GUID for save/load\r\nlocal isChangingSeason = false  -- Debounce flag to prevent rapid clicks\r\nlocal initialized = false  -- Track if setup has been run\r\n\r\n-----------------------------------------\r\n-- Forward declarations for local functions\r\n-----------------------------------------\r\nlocal getWheelEmotion\r\nlocal cycleSeasonWheel\r\nlocal refreshWheelReference\r\nlocal findInnateWithTagInHand\r\nlocal findInnateWithTagInHandObjects\r\nlocal findInnateInHits\r\nlocal getCardEmotion\r\n\r\n-----------------------------------------\r\n-- Local function implementations\r\n-----------------------------------------\r\n\r\n-- Re-find the wheel object (needed because setState destroys and recreates the object)\r\nrefreshWheelReference = function()\r\n    for _, obj in ipairs(getAllObjects()) do\r\n        if obj.getName():find(\"Season Wheel\") then\r\n            seasonWheel = obj\r\n            return true\r\n        end\r\n    end\r\n    seasonWheel = nil\r\n    return false\r\nend\r\n\r\ngetWheelEmotion = function()\r\n    refreshWheelReference()\r\n    if not seasonWheel then return \"Ire\" end\r\n    local stateId = seasonWheel.getStateId()\r\n    if stateId == -1 then stateId = 1 end\r\n    -- States: 1=Ire, 2=Joy, 3=Calm, 4=Sorrow\r\n    return EMOTIONS[stateId] or \"Ire\"\r\nend\r\n\r\n-- Get the emotion tag from a card\r\ngetCardEmotion = function(card)\r\n    if not card then return nil end\r\n    for _, emotion in ipairs(EMOTIONS) do\r\n        if card.hasTag(emotion) then\r\n            return emotion\r\n        end\r\n    end\r\n    return nil\r\nend\r\n\r\n-- Cycle the wheel forward or backward, returning the new emotion tag\r\ncycleSeasonWheel = function(reverse)\r\n    -- Always re-find the wheel in case it was manually changed\r\n    -- (manual state changes destroy the old object and create a new one)\r\n    refreshWheelReference()\r\n    if not seasonWheel then return \"Ire\" end\r\n\r\n    local currentState = seasonWheel.getStateId()\r\n    if currentState == -1 then currentState = 1 end\r\n\r\n    local numStates = #EMOTIONS\r\n    local nextState\r\n    if reverse then\r\n        -- Go backwards: 1->4, 2->1, 3->2, 4->3\r\n        nextState = ((currentState - 2) % numStates) + 1\r\n    else\r\n        -- Go forwards: 1->2, 2->3, 3->4, 4->1\r\n        nextState = (currentState % numStates) + 1\r\n    end\r\n\r\n    -- setState returns new object reference; update our reference\r\n    if nextState ~= currentState then\r\n        seasonWheel = seasonWheel.setState(nextState)\r\n    end\r\n\r\n    return EMOTIONS[nextState] or \"Ire\"\r\nend\r\n\r\nfindInnateWithTagInHand = function(color, handIndex, tagName)\r\n    local hand = Player[color].getHandObjects(handIndex)\r\n    for _, obj in ipairs(hand) do\r\n        if obj.hasTag(\"Innate\") and obj.hasTag(tagName) then\r\n            return obj\r\n        end\r\n    end\r\n    return nil\r\nend\r\n\r\n-- Version that searches a provided hand objects table\r\nfindInnateWithTagInHandObjects = function(handObjects, tagName)\r\n    for _, obj in ipairs(handObjects) do\r\n        if obj.hasTag(\"Innate\") and obj.hasTag(tagName) then\r\n            return obj\r\n        end\r\n    end\r\n    return nil\r\nend\r\n\r\n-- Helper to find Innate card from physics cast hits\r\nfindInnateInHits = function(hits)\r\n    for _, hit in pairs(hits) do\r\n        local card = hit.hit_object\r\n        if card and card.hasTag(\"Innate\") then\r\n            return card\r\n        end\r\n    end\r\n    return nil\r\nend\r\n\r\n-----------------------------------------\r\n-- Save/Load handlers for persistence\r\n-----------------------------------------\r\n\r\nfunction onSave()\r\n    local state = {\r\n        impendTable = impendTable,\r\n        pos = pos,\r\n        playerColor = playerColor,\r\n        panelGUID = panelGUID,\r\n        activated = activated,\r\n        initialized = initialized\r\n    }\r\n    return JSON.encode(state)\r\nend\r\n\r\nfunction onLoad(savedState)\r\n    if savedState and savedState ~= \"\" then\r\n        local state = JSON.decode(savedState)\r\n        if state then\r\n            impendTable = state.impendTable or {}\r\n            playerColor = state.playerColor\r\n            activated = state.activated or false\r\n            initialized = state.initialized or false\r\n            panelGUID = state.panelGUID\r\n            -- Restore pos as a Vector\r\n            if state.pos then\r\n                pos = Vector(state.pos[1] or state.pos.x or 0, \r\n                             state.pos[2] or state.pos.y or 0, \r\n                             state.pos[3] or state.pos.z or 0)\r\n            end\r\n        end\r\n    end\r\n\r\n    -- If we were initialized before save, restore the button\r\n    if initialized and panelGUID then\r\n        Wait.frames(function()\r\n            local panel = getObjectFromGUID(panelGUID)\r\n            if panel then\r\n                createPanelButtons(panel)\r\n            end\r\n            -- Re-hide if it was activated\r\n            if activated then\r\n                self.setInvisibleTo(Player.getColors())\r\n            end\r\n        end, 5)\r\n    end\r\nend\r\n\r\n-----------------------------------------\r\n-- Setup function\r\n-----------------------------------------\r\n\r\nfunction doSetup(params)\r\n    local color = params.color\r\n    playerColor = color\r\n    local panel = params.spiritPanel\r\n    panelGUID = panel.getGUID()  -- Store for save/load\r\n    self.locked = true\r\n    local position = panel.getPosition() + Vector(-8.2,-0.22,6.8)\r\n    pos = position\r\n    self.setPosition(position)\r\n\r\n    -- Find the Season Wheel object by searching for it on the table\r\n    refreshWheelReference()\r\n\r\n    -- Spawn the new hand (hand index 3)\r\n    local handPosition = Player[color].getHandTransform(2).position\r\n    handPosition.z = handPosition.z - 5.5\r\n    Global.call(\"SpawnHand\", {color = color, position = handPosition})\r\n\r\n    -- Determine which emotion the wheel is currently showing\r\n    local startingEmotion = getWheelEmotion()\r\n\r\n    -- Get current hand and process Innate cards\r\n    local hand = Player[color].getHandObjects(1)\r\n    Wait.frames(function()\r\n        if hand ~= {} then\r\n            -- Find the card that matches the wheel's starting emotion\r\n            local startingCard = findInnateWithTagInHandObjects(hand, startingEmotion)\r\n\r\n            for _,card in pairs(hand) do\r\n                if card.hasTag(\"Innate\") then\r\n                    if card == startingCard then\r\n                        -- Place matching card directly on the panel\r\n                        local targetPos = pos + Vector(13, 0.5, -10)\r\n                        card.setPosition(targetPos, false)\r\n                    else\r\n                        -- Send other innates to hand 3\r\n                        card.deal(1, color, 3)\r\n                    end\r\n                end\r\n            end\r\n        end\r\n    end, 1)\r\n\r\n    createPanelButtons(panel)\r\n    initialized = true\r\n\r\n    return true\r\nend\r\n\r\n-----------------------------------------\r\n-- Panel button creation\r\n-----------------------------------------\r\n\r\nfunction createPanelButtons(panel)\r\n    -- Remove existing buttons first to avoid duplicates on reload\r\n    panel.clearButtons()\r\n    \r\n    panel.createButton({\r\n        click_function = \"changeSeason\",\r\n        function_owner = self,\r\n        label = \"Change Season\",\r\n        position = {-0.93,0.5,0},\r\n        scale = {x=0.08, y=0.08, z=0.08},\r\n        width = 5000,\r\n        height = 750,\r\n        font_size = 750,\r\n        color = {1,1,1},\r\n        font_color = {0,0,0},\r\n        tooltip = \"Left-click: Next Season | Right-click: Previous Season\",\r\n    })\r\nend\r\n\r\n-----------------------------------------\r\n-- Change Season (button click handler)\r\n-----------------------------------------\r\n\r\nfunction changeSeason(obj, player_color, alt_click)\r\n    -- Prevent rapid clicks while season change is in progress\r\n    if isChangingSeason then\r\n        return\r\n    end\r\n    isChangingSeason = true\r\n\r\n    -- Hide this script object after first activation\r\n    if not activated then\r\n        activated = true\r\n        self.setInvisibleTo(Player.getColors())\r\n    end\r\n\r\n    local color = Global.call(\"getSpiritColor\", {name = spiritName})\r\n    local reverse = alt_click -- true for right-click (go backwards)\r\n\r\n    -- WHEEL-FIRST LOGIC: Cycle the wheel first, then sync the card to match\r\n    -- This is robust to manual wheel edits or card/wheel desync\r\n    local wantTag = cycleSeasonWheel(reverse)\r\n\r\n    local hits = Physics.cast({\r\n        origin = obj.getPosition() + Vector(5,0,-5),\r\n        direction = Vector(0,1,0),\r\n        type = 3,\r\n        size = {6,1,6.5},\r\n        max_distance = 1,\r\n        -- debug = true\r\n    })\r\n\r\n    -- Find current innate on panel (if any)\r\n    local card = findInnateInHits(hits)\r\n    local targetPos = pos + Vector(13, 0.5, -10)\r\n    local targetRot = Vector(0, 180, 0)\r\n\r\n    if card then\r\n        targetPos = card.getPosition()\r\n        targetRot = card.getRotation()\r\n        -- Move current card to hand 3\r\n        card.deal(1, color, 3)\r\n    end\r\n\r\n    -- Pull the card matching the wheel's new emotion from hand 3\r\n    local replacement = findInnateWithTagInHand(color, 3, wantTag)\r\n    if replacement then\r\n        replacement.setPosition(targetPos, false)\r\n        replacement.setRotation(targetRot, false)\r\n    end\r\n\r\n    -- Release lock after cards have time to settle (~0.5 seconds)\r\n    Wait.frames(function()\r\n        isChangingSeason = false\r\n    end, 30)\r\nend\r\n\r\n-----------------------------------------\r\n-- Time Passes handler\r\n-----------------------------------------\r\n\r\nfunction timePasses()\r\n    -- Prevent rapid calls while season change is in progress\r\n    if isChangingSeason then\r\n        return\r\n    end\r\n    \r\n    local color = Global.call(\"getSpiritColor\", {name = spiritName})\r\n    if not color then return end\r\n\r\n    local hits = Physics.cast({\r\n        origin = self.getPosition() + Vector(5,0,-5),\r\n        direction = Vector(0,1,0),\r\n        type = 3,\r\n        size = {6,1,6.5},\r\n        max_distance = 1,\r\n        -- debug = true\r\n    })\r\n\r\n    -- Find current innate on panel (if any)\r\n    local card = findInnateInHits(hits)\r\n    \r\n    -- Only proceed if there's a card on the panel\r\n    if not card then\r\n        return\r\n    end\r\n    \r\n    isChangingSeason = true\r\n\r\n    -- WHEEL-FIRST LOGIC: Cycle the wheel forward, then sync the card to match\r\n    local wantTag = cycleSeasonWheel(false)  -- always forward for timePasses\r\n    \r\n    -- Check if the card already matches the target emotion (no swap needed)\r\n    local currentEmotion = getCardEmotion(card)\r\n    if currentEmotion == wantTag then\r\n        isChangingSeason = false\r\n        return\r\n    end\r\n\r\n    local targetPos = card.getPosition()\r\n    local targetRot = card.getRotation()\r\n\r\n    -- Move current card to hand 3\r\n    card.deal(1, color, 3)\r\n\r\n    -- Pull the card matching the wheel's new emotion from hand 3\r\n    local replacement = findInnateWithTagInHand(color, 3, wantTag)\r\n    if replacement then\r\n        replacement.setPosition(targetPos, false)\r\n        replacement.setRotation(targetRot, false)\r\n    end\r\n\r\n    -- Release lock after cards have time to settle (~0.5 seconds)\r\n    Wait.frames(function()\r\n        isChangingSeason = false\r\n    end, 30)\r\nend\r\n\r\n-----------------------------------------\r\n-- Cost modification\r\n-----------------------------------------\r\n\r\nfunction modifyCost(params)\r\n    local costs = params.costs\r\n    if params.color == Global.call(\"getSpiritColor\", {name = spiritName}) then\r\n        for guid,_ in pairs(costs) do\r\n            if impendTable[guid] then\r\n                costs[guid] = 0\r\n            end\r\n        end\r\n    end\r\n    return costs\r\nend",
      "LuaScriptState": "{\"g3Selected\":false,\"impendTable\":[],\"initialized\":false}",
      "XmlUI": ""
    }
  ]
}